#! /usr/bin/env bash
#
#/**
# * Licensed to the Apache Software Foundation (ASF) under one
# * or more contributor license agreements.  See the NOTICE file
# * distributed with this work for additional information
# * regarding copyright ownership.  The ASF licenses this file
# * to you under the Apache License, Version 2.0 (the
# * "License"); you may not use this file except in compliance
# * with the License.  You may obtain a copy of the License at
# *
# *     http://www.apache.org/licenses/LICENSE-2.0
# *
# * Unless required by applicable law or agreed to in writing, software
# * distributed under the License is distributed on an "AS IS" BASIS,
# * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# * See the License for the specific language governing permissions and
# * limitations under the License.
# */
#
# Environment Variables:
#
#   JAVA_HOME                The java implementation to use.  Overrides JAVA_HOME.
#   PHOENIX_SHIM_HOME        The phoenix-shim installation directory.
#   PHOENIX_SHIM_CONF_DIR    The phoenix-shim configuration directory.
#   PHOENIX_SHIM_LOG_DIR     The phoenix-shim log directory.
#   PHOENIX_SHIM_PID_DIR     The phoenix-shim pid directory.
#   PHOENIX_REST_HEAPSIZE    The maximum amount of heap to use.
#   PHOENIX_REST_OFFHEAPSIZE The maximum amount of off-heap memory to use.
#   PHOENIX_REST_OPTS        Extra Java runtime options.
#   PHOENIX_DDB_REST_OPTS    Extra Java runtime options for REST server.

bin=`dirname "$0"`
bin=`cd "$bin">/dev/null; pwd`
CLASS=""
REST_CLASSPATH=""

# Helper functions
function append_path() {
  if [ -z "$1" ]; then
    echo "$2"
  else
    echo "$1:$2"
  fi
}

function add_size_suffix() {
    # add an 'm' suffix if the argument is missing one, otherwise use whats there
    local val="$1"
    local lastchar=${val: -1}
    if [[ "mMgG" == *$lastchar* ]]; then
        echo $val
    else
        echo ${val}m
    fi
}

function sighup_handler() {
    # pass through SIGHUP if we can
    if [ -f "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid" ]; then
        kill -s HUP "$(cat "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid")"
    fi
}

function sigterm_handler() {
    if [ -f "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid" ]; then
        echo "Received termination signal, stopping $COMMAND..."
        kill -s TERM "$(cat "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid")"
        # Wait for process to end gracefully
        local pid="$(cat "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid")"
        local count=0
        while kill -0 "$pid" 2>/dev/null && [ $count -lt 30 ]; do
            sleep 1
            count=$((count + 1))
        done
        # Force kill if still running
        if kill -0 "$pid" 2>/dev/null; then
            echo "Force killing $COMMAND (PID: $pid)"
            kill -9 "$pid"
        fi
    fi
    cleanAfterRun
}

function cleanAfterRun() {
    rm -f "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid" > /dev/null 2>&1
}

function validate_config() {
    if [ -z "$JAVA_HOME" ]; then
        echo "Error: JAVA_HOME is not set"
        exit 1
    fi

    if [ -z "$PHOENIX_SHIM_HOME" ]; then
        echo "Error: PHOENIX_SHIM_HOME is not set"
        exit 1
    fi

    if [ ! -d "$PHOENIX_SHIM_HOME" ]; then
        echo "Error: PHOENIX_SHIM_HOME directory does not exist: $PHOENIX_SHIM_HOME"
        exit 1
    fi

    mkdir -p "$PHOENIX_SHIM_LOG_DIR"
    mkdir -p "$PHOENIX_SHIM_PID_DIR"

    if [ ! -w "$PHOENIX_SHIM_LOG_DIR" ]; then
        echo "Error: Cannot write to log directory: $PHOENIX_SHIM_LOG_DIR"
        exit 1
    fi

    if [ ! -w "$PHOENIX_SHIM_PID_DIR" ]; then
        echo "Error: Cannot write to pid directory: $PHOENIX_SHIM_PID_DIR"
        exit 1
    fi
}

function check_before_start() {
    if [ -f "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid" ]; then
        pid=$(cat "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid")
        if kill -0 $pid 2>/dev/null; then
            echo "$COMMAND is already running (pid: $pid)"
            exit 1
        else
            echo "Removing stale pid file"
            rm -f "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid"
        fi
    fi
}

function start_daemon() {
    local args=("$@")
    echo "Starting $COMMAND daemon"
    echo "Using JAVA: $JAVA"
    echo "Using CLASS: $CLASS"
    echo "Using CLASSPATH: $CLASSPATH"
    echo "Using HEAP_SETTINGS: $HEAP_SETTINGS"
    echo "Using PHOENIX_REST_OPTS: $PHOENIX_REST_OPTS"
    echo "Using arguments: ${args[@]}"
    
    "$JAVA" -Dproc_$COMMAND -XX:OnOutOfMemoryError="kill -9 %p" $HEAP_SETTINGS $PHOENIX_REST_OPTS $CLASS "${args[@]}" > "$PHOENIX_SHIM_LOG_DIR/phoenix-shim.log" 2>&1 &
    echo $! > "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid"
    echo "Started $COMMAND daemon (pid: $!)"
}

function foreground_start() {
    local args=("$@")

    # Set up signal traps before starting
    trap sighup_handler HUP
    trap sigterm_handler INT TERM EXIT
    
    # Transform "foreground_start" to "start" for the Java process
    local java_args=()
    for arg in "${args[@]}"; do
        if [ "$arg" = "foreground_start" ]; then
            java_args+=("start")
        else
            java_args+=("$arg")
        fi
    done
    
    # Use start_daemon with transformed arguments
    start_daemon "${java_args[@]}"
    
    # Wait for the process to complete
    if [ -f "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid" ]; then
        local java_pid=$(cat "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid")
        echo "Running in foreground mode (PID: $java_pid). Press Ctrl+C to stop."
        wait $java_pid
    else
        echo "Error: Could not find PID file after starting daemon"
        exit 1
    fi
}

function stop_daemon() {
    if [ -f "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid" ]; then
        pid=$(cat "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid")
        echo "Stopping $COMMAND daemon (pid: $pid)"
        kill $pid
        rm -f "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid"
    else
        echo "No $COMMAND daemon running"
    fi
}

function status_daemon() {
    if [ -f "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid" ]; then
        pid=$(cat "$PHOENIX_SHIM_PID_DIR/$COMMAND.pid")
        if kill -0 $pid 2>/dev/null; then
            echo "$COMMAND daemon is running (pid: $pid)"
            return 0
        else
            echo "$COMMAND daemon is not running (stale pid file)"
            return 1
        fi
    else
        echo "$COMMAND daemon is not running"
        return 1
    fi
}

function show_usage() {
  echo "Usage: phoenix-shim [<options>] <command> [<args>]"
  echo "$options_string"
  echo ""
  echo "Commands:"
  echo "  rest <subcommand>   REST server commands"
  echo "    start            Start the REST server"
  echo "    stop             Stop the REST server"
  echo "    status           Check REST server status"
  echo "    restart          Restart the REST server"
  echo "    foreground_start Start the REST server in foreground"
  echo ""
  echo "  CLASSNAME          Run the class named CLASSNAME"
  echo ""
  echo "Examples:"
  echo "  phoenix-shim rest start           # Start the REST server"
  echo "  phoenix-shim rest stop            # Stop the REST server"
  echo "  phoenix-shim rest status          # Check REST server status"
  echo "  phoenix-shim rest restart         # Restart the REST server"
  echo "  phoenix-shim rest foreground_start # Start the REST server in foreground"
  echo ""
  echo "Environment Variables:"
  echo "  JAVA_HOME                The java implementation to use"
  echo "  PHOENIX_SHIM_HOME        The phoenix-shim installation directory"
  echo "  PHOENIX_SHIM_CONF_DIR    The phoenix-shim configuration directory"
  echo "  PHOENIX_SHIM_LOG_DIR     The phoenix-shim log directory"
  echo "  PHOENIX_SHIM_PID_DIR     The phoenix-shim pid directory"
  echo "  PHOENIX_REST_HEAPSIZE    The maximum amount of heap to use"
  echo "  PHOENIX_REST_OFFHEAPSIZE The maximum amount of off-heap memory to use"
  echo "  PHOENIX_REST_OPTS        Extra Java runtime options"
  echo "  PHOENIX_DDB_REST_OPTS    Extra Java runtime options for REST server"
}

# Define options string
read -d '' options_string << EOF
Options:
  --help or -h         Print this help message
EOF

# Handle help option
if [ "--help" = "$1" ] || [ "-h" = "$1" ]; then
  show_usage
  exit 0
fi

# Load configuration
. "$bin"/shim-config.sh

# Validate configuration
validate_config

# Set up Java environment
JAVA="$JAVA_HOME/bin/java"

# Set up heap settings
if [[ -n "$PHOENIX_REST_HEAPSIZE" ]]; then
    JAVA_HEAP_MAX="-Xmx$(add_size_suffix $PHOENIX_REST_HEAPSIZE)"
fi

if [[ -n "$PHOENIX_REST_OFFHEAPSIZE" ]]; then
    JAVA_OFFHEAP_MAX="-XX:MaxDirectMemorySize=$(add_size_suffix $PHOENIX_REST_OFFHEAPSIZE)"
fi

HEAP_SETTINGS="$JAVA_HEAP_MAX $JAVA_OFFHEAP_MAX"

# Initialize CLASSPATH
CLASSPATH="${PHOENIX_SHIM_CONF_DIR}:$JAVA_HOME/lib/tools.jar"

# Set up logging options
if [ -z "${PHOENIX_SHIM_LOGGING_OPTS}" ]; then
    PHOENIX_SHIM_LOGGING_OPTS="-Dlog4j2.configurationFile=file:$PHOENIX_SHIM_CONF_DIR/log4j2.properties"
    export PHOENIX_SHIM_LOGGING_OPTS
fi

# Set up REST options
if [ -z "${PHOENIX_REST_OPTS}" ] ; then
    PHOENIX_REST_OPTS="-XX:+UseG1GC"
    PHOENIX_REST_OPTS="$PHOENIX_REST_OPTS -XX:+HeapDumpOnOutOfMemoryError"
    PHOENIX_REST_OPTS="$PHOENIX_REST_OPTS -XX:HeapDumpPath=$PHOENIX_SHIM_LOG_DIR"
    PHOENIX_REST_OPTS="$PHOENIX_REST_OPTS -XX:+UseGCLogFileRotation"
    PHOENIX_REST_OPTS="$PHOENIX_REST_OPTS -XX:NumberOfGCLogFiles=5"
    PHOENIX_REST_OPTS="$PHOENIX_REST_OPTS -XX:GCLogFileSize=20M"
    PHOENIX_REST_OPTS="$PHOENIX_REST_OPTS -XX:+PrintGCDetails"
    PHOENIX_REST_OPTS="$PHOENIX_REST_OPTS -XX:+PrintGCDateStamps"
    PHOENIX_REST_OPTS="$PHOENIX_REST_OPTS -Xloggc:$PHOENIX_SHIM_LOG_DIR/gc.log"
    export PHOENIX_REST_OPTS
fi

# Handle command line arguments
if [ $# = 0 ]; then
  show_usage
  exit 1
fi

COMMAND=$1
shift

# Handle 'rest' command
if [ "$COMMAND" = "rest" ]; then
    SUBCOMMAND=$1
    shift
    if [ -z "$SUBCOMMAND" ]; then
        echo "Error: No subcommand specified for 'rest'"
        show_usage
        exit 1
    fi

    # Handle Java library path if set
    if [ "x$JAVA_LIBRARY_PATH" != "x" ]; then
        PHOENIX_REST_OPTS="$PHOENIX_REST_OPTS -Djava.library.path=$JAVA_LIBRARY_PATH"
        export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$JAVA_LIBRARY_PATH"
    fi

    
    # Set up REST server specific variables
    CLASS="org.apache.phoenix.ddb.rest.RESTServer"
    REST_CLASSPATH="${PHOENIX_SHIM_HOME}/lib/*"
    CLASSPATH="${CLASSPATH}:${REST_CLASSPATH}"

    export CLASSPATH

    echo "Using the classpath: $CLASSPATH"
    
    REST_CMD_ARGS=()
    
    # Parse remaining arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -z|--zkquorum)
                REST_CMD_ARGS+=("-z" "$2")
                shift 2
                ;;
            -p|--port)
                REST_CMD_ARGS+=("-p" "$2")
                shift 2
                ;;
            *)
                echo "Unknown option: $1"
                show_usage
                exit 1
                ;;
        esac
    done
    
    # Add the subcommand to the arguments
    REST_CMD_ARGS=("$SUBCOMMAND" "${REST_CMD_ARGS[@]}")
    
    if [ "$SUBCOMMAND" != "stop" ] ; then
        PHOENIX_REST_OPTS="$PHOENIX_REST_OPTS $PHOENIX_DDB_REST_OPTS"
    fi
    
    case "$SUBCOMMAND" in
        start)
            check_before_start
            start_daemon "${REST_CMD_ARGS[@]}"
            ;;
        stop)
            stop_daemon
            ;;
        status)
            status_daemon
            ;;
        restart)
            stop_daemon
            sleep 2  # Give the process time to stop
            start_daemon "${REST_CMD_ARGS[@]}"
            ;;
        foreground_start)
            foreground_start "${REST_CMD_ARGS[@]}"
            ;;
        *)
            echo "Unknown subcommand: $SUBCOMMAND"
            show_usage
            exit 1
            ;;
    esac
else
    # Handle other commands
    CMD_ARGS=("$@")
    case "$COMMAND" in
        start)
            check_before_start
            start_daemon "${CMD_ARGS[@]}"
            ;;
        stop)
            stop_daemon
            ;;
        status)
            status_daemon
            ;;
        restart)
            stop_daemon
            sleep 2
            start_daemon "${CMD_ARGS[@]}"
            ;;
        foreground_start)
            foreground_start "${CMD_ARGS[@]}"
            ;;
        *)
            echo "Unknown command: $COMMAND"
            show_usage
            exit 1
            ;;
    esac
fi
